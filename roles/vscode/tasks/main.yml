- name: Install Visual Studio Code (Microsoft product)
  become_user: '{{ arch_user }}'
  become: true
  kewlfft.aur.aur:
    name:
      - visual-studio-code-bin
    use: yay

- name: List VS Code extensions, with versions
  become_user: '{{ arch_user }}'
  become: true
  ansible.builtin.command:
    cmd: code --list-extensions --show-versions
  register: code_list_extensions
  changed_when: false

- name: Install VS Code extensions from registry
  ansible.builtin.command:
    cmd: 'code --install-extension {{ item.name }}@{{ item.version }}'
  when: '"{{ item.name }}@{{ item.version}}" not in code_list_extensions.stdout'
  loop:
    - { name: 'BazelBuild.vscode-bazel', version: '0.5.0' }
    - { name: 'golang.go', version: '0.29.0' }
    - { name: 'matklad.rust-analyzer', version: '0.2.809' }
    - { name: 'vscodevim.vim', version: '1.21.10' }
    - { name: 'zxh404.vscode-proto3', version: '0.5.5' }

- name: Link settings.json into place
  ansible.builtin.file:
    src: '{{ role_path }}/files/settings.json'
    dest: '{{ arch_home }}/.config/Code/User/settings.json'
    state: link
